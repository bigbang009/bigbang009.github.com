---
layout:     post
title:      为什么mkfs之后uuid没有立刻更新
subtitle:   为什么mkfs之后uuid没有立刻更新
date:       2020-07-01
author:     lwk
catalog: true
tags:
    - linux
    - mkfs
---
问题背景：

虚拟机上通过mkfs.xfs格式化盘时，/dev/disk/by-uuid没有实时更新？

通过shell脚本对某块云盘进行格式化，并获取格式化后的/dev/disk/by-uuid/结果时，得到的结果时格式化前的旧数据。

脚本大概内容：

mkfs.xfs -f /dev/vdb

find /dev/disk/by-uuid/ -type l

但是通过在格式化和find之间加入sleep1就能得到最新结果。初步怀疑格式化更新/dev/disk/by-uuid不是实时的。

猜想：可能是子机执行时，陷入handle_exit到母机的qemu_io线程，最后由母机进行调度到cpu上执行耗时比较高导致？

 

验证1：

mkfs.xfs -f /dev/vde && stat/dev/disk/by-uuid/*

获取到by-uuid结果是旧的

验证2：

mkfs.xfs -f /dev/vde && sleep 1&& stat /dev/disk/by-uuid/*

获取到by-uuid结果是新的

验证3：

mkfs.xfs -f /dev/vde && sleep 0.5&& stat /dev/disk/by-uuid/*

获取到by-uuid结果是新的

验证4：

mkfs.xfs -f /dev/vde && sleep 0.02&& stat /dev/disk/by-uuid/*

获取到by-uuid结果偶尔是新的，偶尔是旧的

 

先自己通过GDB调试看下效果：

xfsprogs源码地址：

http://www.linuxfromscratch.org/blfs/view/svn/postlfs/xfsprogs.html

编译源码，并通过GDB单步调试。

1、先在虚拟机上执行GDB
